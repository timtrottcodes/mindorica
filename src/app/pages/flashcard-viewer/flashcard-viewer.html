<div class="container text-center my-5">
  <h2 class="mb-3">{{ topicId }}</h2>
  <p *ngIf="!reviewingDone">
    Press space to flip. Then rate: 1 (Don't Know), 2 (Hard), 3 (Good), 4 (Easy)
  </p>

  <div
    *ngIf="!reviewingDone"
    class="progress-container"
    aria-label="Study progress"
  >
    <div
      class="progress-bar"
      [style.width.%]="(currentIndex / cards.length) * 100"
    ></div>
    <span class="progress-text">{{ currentIndex }} / {{ cards.length }}</span>
  </div>

  <app-flashcard
    *ngIf="!reviewingDone && currentCard"
    [card]="currentCard"
    [showBack]="showBack"
    (flip)="flip()"
  ></app-flashcard>

  <div
    *ngIf="currentCard && currentCard.options && currentCard.options.length > 0"
  >
    <div class="list-group">
      <button
        class="list-group-item list-group-item-action"
        [ngClass]="{
          active: selectedOption === opt.back,
          'list-group-item-success':
            selectedOption && opt.back === currentCard!.back,
          'list-group-item-danger':
            selectedOption &&
            opt.back === selectedOption &&
            opt.back !== currentCard!.back
        }"
        *ngFor="let opt of getMultipleChoiceOptions(currentCard!)"
        (click)="onSelectOption(opt.back, currentCard!.back)"
        [disabled]="selectedOption"
      >
        <img
          *ngIf="opt.imageBack && opt.imageUrl"
          [src]="opt.imageUrl"
          alt="Back image"
          class="img-fluid flashcard-image mb-2"
        />
        <p>{{ opt.back }}</p>
      </button>
    </div>
    <div *ngIf="selectedOption">
      <p
        [class.text-success]="selectedOption === currentCard!.back"
        [class.text-danger]="selectedOption !== currentCard!.back"
      >
        {{
          selectedOption === currentCard!.back
            ? "âœ… Correct!"
            : "âŒ That is incorrect. The correct answer is: " +
              currentCard!.back
        }}
      </p>
      <button class="btn btn-primary btn-sm" (click)="rateCard(1)">Next</button>
    </div>
  </div>

  <div class="mt-3" *ngIf="!selectedOption && showBack && !reviewingDone">
    <button (click)="rateCard(1)" class="btn btn-danger mx-1">
      Don't Know (1)
    </button>
    <button (click)="rateCard(2)" class="btn btn-danger mx-1">Hard (2)</button>
    <button (click)="rateCard(3)" class="btn btn-warning mx-1">Good (3)</button>
    <button (click)="rateCard(4)" class="btn btn-success mx-1">Easy (4)</button>
  </div>

  <div class="alert alert-info mt-4" *ngIf="feedback">{{ feedback }}</div>
  <div class="alert alert-success" *ngIf="reviewingDone">
    ğŸ‰ You've completed the session!
  </div>

  <div *ngIf="reviewingDone" class="text-center mt-5">
    <h2 class="mb-3 text-success">ğŸ‰ Review Complete!</h2>

    <div class="mb-4">
      <h4>Your Score</h4>
      <div class="progress mb-2" style="height: 25px">
        <div
          class="progress-bar bg-success"
          role="progressbar"
          [style.width.%]="scorePercent"
          aria-valuemin="0"
          aria-valuemax="100"
        >
          {{ scorePercent.toFixed(0) }}%
        </div>
      </div>
      <p>
        You reviewed {{ cards.length }} cards. Your average rating was
        <strong>{{ averageRating.toFixed(2) }}</strong
        >.
      </p>
    </div>

    <table class="table mt-4">
      <thead>
        <tr>
          <th>Card</th>
          <th>Rating</th>
          <th>Next Review</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let entry of studyHistory">
          <td>{{ entry.card.front }}</td>
          <td>{{ entry.rating }}</td>
          <td>{{ entry.nextReviewDate | date : "shortDate" }}</td>
        </tr>
      </tbody>
    </table>

    <div class="mb-3" *ngIf="cardsToReview.length > 0">
      <h5 class="text-warning">âš ï¸ Cards that need more work:</h5>
      <ul class="list-unstyled">
        <li *ngFor="let item of cardsToReview">
          <code>{{ item.front }}</code> â€” rated {{ item.rating }}
        </li>
      </ul>
    </div>

    <p class="lead mt-3">
      {{ finalMessage }}
    </p>

    <button class="btn btn-outline-primary mx-2" (click)="restart()">
      ğŸ” Review Again
    </button>
    <button class="btn btn-outline-primary mx-2" (click)="topics()">
      Return to Topics
    </button>
  </div>
</div>
